<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório Gerencial • Chiquinho Sorvetes</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            /* Cores da Marca Modernizadas */
            --brand-blue: #003087;
            --brand-blue-dark: #002260;
            --brand-orange: #F15A29;

            /* Semântica */
            --success-bg: #DCFCE7;
            --success-text: #166534;
            --danger-bg: #FEE2E2;
            --danger-text: #991B1B;
            --warning-bg: #FEF3C7;
            --warning-text: #92400E;

            /* Neutros */
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --bg-light: #F9FAFB;
            --border-color: #E5E7EB;

            /* Tipografia */
            --font-main: 'Inter', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background-color: white;
            border-bottom: 4px solid var(--brand-orange);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        header h1 {
            color: var(--brand-blue-dark);
            font-size: 2.2em;
            margin: 0 0 5px 0;
            font-weight: 800;
        }

        header p {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin: 0;
        }

        .section-header {
            border-left: 5px solid var(--brand-orange);
            padding-left: 15px;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--brand-blue-dark);
            margin: 0;
        }

        .section-subtitle {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--brand-blue);
        }

        .kpi-label {
            font-size: 0.8em;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .kpi-value {
            font-size: 2em;
            font-weight: 800;
            color: var(--text-primary);
        }

        .row-2 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card-large {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .card-header h3 {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--brand-blue-dark);
            margin: 0 0 20px 0;
        }

        /* Tabela Contas */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
            font-size: 0.9em;
        }

        th {
            background-color: var(--bg-light);
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Badges de Status */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.a_vencer {
            background-color: var(--warning-bg);
            color: var(--warning-text);
        }

        .badge.vencido {
            background-color: var(--danger-bg);
            color: var(--danger-text);
        }

        .badge.pago {
            background-color: var(--success-bg);
            color: var(--success-text);
        }

        /* Gráficos */
        .chart-container {
            height: 300px;
            width: 100%;
        }

        /* FOTO GRID – cards mais profissionais */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 24px;
            margin-top: 20px;
        }

        .comparison-card {
            background-color: #ffffff;
            border-radius: 14px;
            padding: 14px 16px 12px;
            box-shadow: 0 10px 18px rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(148, 163, 184, 0.35);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .comparison-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 10px;
        }

        .tag-tipo {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 4px 10px;
            border-radius: 999px;
        }

        .tag-tipo.melhoria {
            background: rgba(34, 197, 94, 0.12);
            color: #15803d;
        }

        .tag-tipo.registro {
            background: rgba(59, 130, 246, 0.12);
            color: #1d4ed8;
        }

        .comparison-caption {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: right;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .comparison-images {
            display: flex;
            gap: 12px;
        }

        .img-box {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .img-box img {
            width: 100%;
            height: 210px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: transform 0.25s ease-out;
        }

        .comparison-card:hover .img-box img {
            transform: scale(1.02);
        }

        .img-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary);
            padding-top: 6px;
            text-transform: uppercase;
        }

        /* remove h4 antigo dentro dos cards de foto */
        .photo-grid h4 {
            display: none;
        }

        .finance-summary {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            /* Estilos para os novos cartões de resumo */
        }

        .total-box {
            flex: 1;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
        }

        .status-label {
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-warning {
            color: var(--warning-text);
        }

        .status-danger {
            color: var(--danger-text);
        }

        .status-success {
            color: var(--success-text);
        }

        .total-value {
            font-size: 1.8em;
            font-weight: 800;
            margin: 5px 0 0 0;
            color: var(--text-primary);
        }

        /* Estilos para a lista de contas no corpo do html */
        .table-container td:nth-child(5) {
            color: var(--brand-blue-dark);
        }

        /* Estilos para detalhamento de formas de pagamento */
        .formas-detalhes {
            padding: 10px 0;
        }

        .formas-lista {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .forma-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .forma-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .forma-nome-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .forma-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }

        .forma-nome {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95em;
        }

        .forma-valores {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .forma-porcentagem {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--brand-blue-dark);
            min-width: 50px;
            text-align: right;
        }

        .forma-valor {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9em;
            min-width: 100px;
            text-align: right;
        }

        .forma-bar-container {
            width: 100%;
            height: 8px;
            background-color: var(--bg-light);
            border-radius: 4px;
            overflow: hidden;
        }

        .forma-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
    </style>
</head>

<body>
    {% if erro %}
    <div class="container" style="text-align: center; padding: 50px; background: #fee2e2; border: 1px solid #991B1B;">
        <h1 style="color: #991B1B;">Erro Fatal de Leitura do Excel</h1>
        <p>{{ erro|safe }}</p>
    </div>
    {% else %}
    <header>
        <h1>Relatório Gerencial Chiquinho Sorvetes</h1>
        <p>Análise de Desempenho e Financeira – Período: **{{ periodo }}** | Data de Emissão: {{ data_hoje }}</p>
    </header>

    <div class="container">

        <div class="section-header">
            <h2 class="section-title">Performance da Semana</h2>
            <p class="section-subtitle">Dados de Vendas, Ticket Médio e Movimentação Financeira</p>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card" style="border-left-color: #10B981;">
                <div class="kpi-label" style="color: #10B981;">Faturamento Total</div>
                <div class="kpi-value">R$ {{ faturamento_total | brl }}</div>
            </div>
            <div class="kpi-card" style="border-left-color: var(--brand-orange);">
                <div class="kpi-label" style="color: var(--brand-orange);">Clientes Atendidos</div>
                <div class="kpi-value">{{ clientes_total }}</div>
            </div>
            <div class="kpi-card" style="border-left-color: var(--brand-blue);">
                <div class="kpi-label" style="color: var(--brand-blue);">Ticket Médio</div>
                <div class="kpi-value">R$ {{ ticket_medio | brl }}</div>
            </div>
            <div class="kpi-card" style="border-left-color: #6366F1;">
                <div class="kpi-label" style="color: #6366F1;">Melhor Dia ({{ melhor_dia }})</div>
                <div class="kpi-value">R$ {{ melhor_dia_valor | brl }}</div>
            </div>
        </div>

        <!-- CARDS DE CUSTOS OPERACIONAIS -->
        <div class="kpi-grid">
            <div class="kpi-card" style="border-left-color: #EF4444;">
                <div class="kpi-label" style="color: #EF4444;">Total Sangrias</div>
                <div class="kpi-value">R$ {{ sangrias.total | brl }}</div>
                <div style="font-size: 0.75em; color: var(--text-secondary); margin-top: 5px;">
                    {{ sangrias.quantidade }} operações realizadas
                </div>
            </div>
            <div class="kpi-card" style="border-left-color: #8B5CF6;">
                <div class="kpi-label" style="color: #8B5CF6;">Despesas Extras</div>
                <div class="kpi-value">R$ {{ despesas_extras.total | brl }}</div>
                <div style="font-size: 0.75em; color: var(--text-secondary); margin-top: 5px;">
                    {{ despesas_extras.lista|length }} registros
                    {% if despesas_extras.fora_caixa > 0 %}
                    <span style="color: #991B1B; font-weight: 600; display: block; margin-top: 2px;">
                        ⚠️ R$ {{ despesas_extras.fora_caixa | brl }} fora do caixa
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="kpi-card" style="border-left-color: #F59E0B;">
                <div class="kpi-label" style="color: #F59E0B;">Saídas Totais</div>
                <div class="kpi-value">R$ {{ saidas_total | brl }}</div>
                <div style="font-size: 0.75em; color: var(--text-secondary); margin-top: 5px;">
                    Sangrias + Despesas Extras
                </div>
            </div>
            <div class="kpi-card" style="border-left-color: #10B981;">
                <div class="kpi-label" style="color: #10B981;">Saldo Final de Caixa</div>
                <div class="kpi-value">R$ {{ saldo_caixa | brl }}</div>
                <div style="font-size: 0.75em; color: var(--text-secondary); margin-top: 5px;">
                    Entradas - Saídas
                </div>
            </div>
        </div>

        <div class="row-2">
            <div class="card-large">
                <div class="card-header">
                    <h3>Vendas Diárias (R$)</h3>
                </div>
                <div class="chart-container">
                    <canvas id="vendasChart"></canvas>
                </div>
            </div>

            <div class="card-large">
                <div class="card-header">
                    <h3>Resumo de Caixa</h3>
                </div>
                <div style="font-size: 1em;">
                    <p style="font-weight: 600; color: #10B981; margin-top: 0;">Entradas Totais: <span
                            style="float: right;">R$ {{ faturamento_total | brl }}</span></p>
                    <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 10px 0;">
                    <p style="color: var(--text-secondary);">Sangrias: <span style="float: right;">- R$ {{
                            sangrias.total | brl }}</span></p>
                    <p style="color: var(--text-secondary);">Despesas Extras: <span style="float: right;">- R$ {{
                            despesas_extras.total | brl }}</span></p>
                    <hr style="border: 0; border-top: 2px solid var(--text-primary); margin: 15px 0;">
                    <p style="font-weight: 700; font-size: 1.5em; color: var(--brand-blue-dark);">Saldo de Caixa: <span
                            style="float: right;">R$ {{ saldo_caixa | brl }}</span></p>
                </div>
            </div>
        </div>

        <div class="row-2">
            <div class="card-large">
                <div class="card-header">
                    <h3>Distribuição de Vendas por Forma de Pagamento</h3>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1.2fr; gap: 20px; align-items: start;">
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="formasChart"></canvas>
                    </div>
                    <div class="formas-detalhes">
                        <div class="formas-detalhes-header">
                            <h4
                                style="margin: 0 0 15px 0; font-size: 1em; color: var(--text-secondary); font-weight: 600; text-transform: uppercase;">
                                Detalhamento</h4>
                        </div>
                        <div class="formas-lista">
                            {% for forma in formas_pagamento %}
                            <div class="forma-item">
                                <div class="forma-info">
                                    <div class="forma-nome-wrapper">
                                        <span class="forma-indicator"
                                            style="background-color: {{ ['#003087', '#F15A29', '#10B981', '#F59E0B', '#6366F1', '#8B5CF6', '#EC4899'][loop.index0 % 7] }};"></span>
                                        <span class="forma-nome">{{ forma.nome }}</span>
                                    </div>
                                    <div class="forma-valores">
                                        <span class="forma-porcentagem">{{ forma.porcentagem }}%</span>
                                        <span class="forma-valor">R$ {{ forma.valor | brl }}</span>
                                    </div>
                                </div>
                                <div class="forma-bar-container">
                                    <div class="forma-bar"
                                        style="width: {{ forma.porcentagem }}%; background-color: {{ ['#003087', '#F15A29', '#10B981', '#F59E0B', '#6366F1', '#8B5CF6', '#EC4899'][loop.index0 % 7] }};">
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-large">
                <div class="card-header">
                    <h3>Top 10 Produtos Mais Vendidos (Quantidade)</h3>
                </div>
                <div class="chart-container" style="height: 350px;">
                    <canvas id="topProdutos"></canvas>
                </div>
            </div>
        </div>

        <!-- NOVA SEÇÃO: DETALHAMENTO DE SANGRIAS E DESPESAS -->
        <div class="section-header">
            <h2 class="section-title">Detalhamento de Custos Operacionais</h2>
            <p class="section-subtitle">Análise completa de Sangrias e Despesas Extras</p>
        </div>

        <div class="card-large" style="margin-bottom: 30px;">
            <div class="card-header">
                <h3>Detalhamento de Sangrias</h3>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Motivo</th>
                            <th>Observações</th>
                            <th style="text-align: right;">Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in sangrias.lista %}
                        <tr>
                            <td>{{ s.data }}</td>
                            <td style="font-weight: 500;">{{ s.motivo }}</td>
                            <td style="color: var(--text-secondary); font-size: 0.85em;">{{ s.observacoes }}</td>
                            <td style="text-align: right; font-weight: 600; color: #EF4444;">R$ {{ s.valor | brl }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" style="text-align: center; color: var(--text-secondary);">Nenhuma sangria
                                registrada.</td>
                        </tr>
                        {% endfor %}
                        <tr style="background-color: var(--bg-light); font-weight: 700;">
                            <td colspan="3" style="text-align: right; padding-right: 20px;">TOTAL:</td>
                            <td style="text-align: right; color: #EF4444;">R$ {{ sangrias.total | brl }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-large" style="margin-bottom: 30px;">
            <div class="card-header">
                <h3>Detalhamento de Despesas Extras</h3>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descrição</th>
                            <th>Categoria</th>
                            <th style="text-align: right;">Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for d in despesas_extras.lista %}
                        <tr>
                            <td>{{ d.data }}</td>
                            <td style="font-weight: 500;">{{ d.descricao }}</td>
                            <td><span class="badge" style="background: #E0F2FE; color: #075985;">{{ d.categoria
                                    }}</span></td>
                            <td style="text-align: right; font-weight: 600; color: #8B5CF6;">R$ {{ d.valor | brl }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" style="text-align: center; color: var(--text-secondary);">Nenhuma despesa
                                extra registrada.</td>
                        </tr>
                        {% endfor %}
                        <tr style="background-color: var(--bg-light); font-weight: 700;">
                            <td colspan="3" style="text-align: right; padding-right: 20px;">TOTAL:</td>
                            <td style="text-align: right; color: #8B5CF6;">R$ {{ despesas_extras.total | brl }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section-header">
            <h2 class="section-title">Agenda Financeira & Contas</h2>
        </div>

        <div class="card-large">
            <div class="finance-summary">
                <div class="total-box">
                    <span class="status-label status-warning">A Vencer</span>
                    <p class="total-value" id="valor_a_vencer">R$ {{ a_vencer | brl }}</p>
                </div>
                <div class="total-box">
                    <span class="status-label status-danger">Vencido</span>
                    <p class="total-value" id="valor_vencido">R$ {{ vencido | brl }}</p>
                </div>
                <div class="total-box">
                    <span class="status-label status-success">Pago</span>
                    <p class="total-value" id="valor_pago">R$ {{ pago | brl }}</p>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Fornecedor</th>
                            <th>Descrição</th>
                            <th>Vencimento</th>
                            <th>Status</th>
                            <th style="text-align: right;">Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in contas %}
                        <tr>
                            <td style="font-weight: 500;">{{ c.fornecedor }}</td>
                            <td style="color: var(--text-secondary);">{{ c.descricao }}</td>
                            <td>{{ c.vencimento }}</td>
                            <td><span class="badge {{ c.status|lower|replace(' ', '_') }}">{{ c.status }}</span></td>
                            <td style="text-align: right; font-weight: 600;">R$ {{ c.valor | brl }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" style="text-align: center; color: var(--text-secondary);">Nenhuma conta
                                registrada.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% if fotos_melhorias %}
        <div class="section-header" style="margin-top: 40px;">
            <h2 class="section-title">Registro de Melhorias e Ações</h2>
            <p class="section-subtitle">Evidências fotográficas de melhorias, reformas e registros operacionais.</p>
        </div>

        <div class="photo-grid">
            {% for foto_item in fotos_melhorias %}
            <div class="comparison-card">
                <div class="comparison-header">
                    <span class="tag-tipo {% if foto_item.tipo == 'MELHORIA' %}melhoria{% else %}registro{% endif %}">
                        {% if foto_item.tipo == 'MELHORIA' %}
                        Melhoria
                        {% else %}
                        Registro
                        {% endif %}
                    </span>
                    <span class="comparison-caption">
                        {{ foto_item.titulo }}
                    </span>
                </div>

                <div class="comparison-images">
                    {% if foto_item.tipo == 'MELHORIA' %}
                    <div class="img-box">
                        <img src="{{ foto_item.antes }}" alt="Antes"
                            onerror="this.src='https://placehold.co/300x200/ccc/666?text=ANTES'">
                        <div class="img-label">Antes</div>
                    </div>
                    <div class="img-box">
                        <img src="{{ foto_item.depois }}" alt="Depois"
                            onerror="this.src='https://placehold.co/300x200/27ae60/ffffff?text=DEPOIS'">
                        <div class="img-label">Depois</div>
                    </div>
                    {% else %}
                    <div class="img-box">
                        <img src="{{ foto_item.depois }}" alt="{{ foto_item.titulo }}"
                            onerror="this.src='https://placehold.co/400x260/27ae60/ffffff?text=REGISTRO'">
                        <div class="img-label">Registro</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}


    </div>
    {% endif %}

    <script>
        // Dados para os gráficos vêm do Flask (Python)
        var vendasData = {{ valores_diarios | tojson }};
        var datasData = {{ datas_diarias | tojson }};

        // Gráfico de Vendas Diárias
        new Chart(document.getElementById('vendasChart'), {
            type: 'line',
            data: {
                labels: datasData,
                datasets: [{
                    label: 'Vendas (R$)',
                    data: vendasData,
                    borderColor: '#003087',
                    backgroundColor: 'rgba(0, 48, 135, 0.1)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: '#003087'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Gráfico Formas de Pagamento
        var formasData = {{ formas_pagamento | tojson }};
        var formasLabels = formasData.map(f => f.nome);
        var formasValores = formasData.map(f => f.valor);
        var formasPorcentagens = formasData.map(f => f.porcentagem);
        var formasCores = ['#003087', '#F15A29', '#10B981', '#F59E0B', '#6366F1', '#8B5CF6', '#EC4899'];
        var totalFormas = formasValores.reduce((a, b) => a + b, 0);

        // Plugin para adicionar texto no centro do gráfico
        var centerTextPlugin = {
            id: 'centerText',
            afterDraw: function (chart) {
                var ctx = chart.ctx;
                var centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                var centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;

                ctx.save();
                ctx.font = 'bold 14px Inter';
                ctx.fillStyle = '#1F2937';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('Total', centerX, centerY - 12);

                ctx.font = 'bold 20px Inter';
                ctx.fillStyle = '#003087';
                ctx.fillText('R$ ' + totalFormas.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), centerX, centerY + 8);
                ctx.restore();
            }
        };

        var formasChart = new Chart(document.getElementById('formasChart'), {
            type: 'doughnut',
            data: {
                labels: formasLabels,
                datasets: [{
                    data: formasValores,
                    backgroundColor: formasCores.slice(0, formasLabels.length),
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                var index = context.dataIndex;
                                var value = context.parsed || 0;
                                var porcentagem = formasPorcentagens[index];
                                return formasLabels[index] + ': ' + porcentagem + '% (R$ ' + value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ')';
                            }
                        }
                    }
                },
                cutout: '60%',
                layout: {
                    padding: 15
                }
            },
            plugins: [centerTextPlugin]
        });

        // Gráfico Top Produtos
        var produtosData = {{ top_produtos | tojson }};
        var produtosLabels = produtosData.map(p => p[0]);
        var produtosQuantidades = produtosData.map(p => p[1]);

        // Plugin para adicionar labels nas barras
        var barLabelsPlugin = {
            id: 'barLabels',
            afterDatasetsDraw: function (chart) {
                var ctx = chart.ctx;
                var meta = chart.getDatasetMeta(0);

                ctx.save();
                ctx.font = 'bold 11px Inter';
                ctx.fillStyle = '#1F2937';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';

                meta.data.forEach(function (bar, index) {
                    var value = produtosQuantidades[index];
                    // Para gráficos horizontais (indexAxis: 'y'), x é a posição final da barra
                    var x = bar.x;
                    var y = bar.y;

                    // Posiciona o texto no final da barra com um pequeno espaçamento
                    ctx.fillText(value + ' un', x + 8, y);
                });

                ctx.restore();
            }
        };

        var topProdutosChart = new Chart(document.getElementById('topProdutos'), {
            type: 'bar',
            data: {
                labels: produtosLabels,
                datasets: [{
                    label: 'Quantidade',
                    data: produtosQuantidades,
                    backgroundColor: '#F15A29',
                    borderRadius: 4,
                    barPercentage: 0.7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return 'Quantidade: ' + context.parsed.x + ' unidades';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: {
                            display: false
                        },
                        ticks: {
                            stepSize: 1,
                            maxTicksLimit: 10
                        }
                    },
                    y: {
                        grid: {
                            display: false
                        }
                    }
                }
            },
            plugins: [barLabelsPlugin]
        });
    </script>
</body>

</html>